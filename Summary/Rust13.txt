13章 ユーティリティトレイト

演算子オーバーロード以外にも組み込みトレイトを使って機能をフックできる

本章はRustのstdライブラリで提供される有用なトレイトを紹介
→トレイト各種はp.273など

13.1 Drop

値をdropする時は色々解放しなければならない

式の値が;演算子で捨てられた時などにもdropは発生する

ほとんどの場合においてRustは自動的にdropしてくれる

std::ops::Dropトレイトを実装
→独自型の値がdropされる時の動作をカスタマイズできる

値がdropされる時std::ops::Dropを実装していたら、各データをdropする前にdropメソッドを呼ぶ
→dropメソッドはこの暗黙の呼び出し以外で呼び出せない
→→Drop::dropが受け取る値は完全に値が入った状態になる

trait Drop {
    fn drop(&mut self);
}

値そのものの解放
→VecやString、変数などが請け負う

変数のスコープが終わるときに未初期化
→その変数をドロップしようとしない
→→制御フローによって値が移動されているかわからないときも適用される
→→→変数の状態を見えないフラグとして保持してドロップする必要があるかを管理

Rustが知らない資源を管理する型を定義しているのでもない限りDropを実装する必要はない

ある型がDropトレイトを実装
→その方はCopyトレイトを実装できない
→→同じデータに対して2回以上dropが呼び出されるのはあまりよくない

標準プレリュードのdropは単純(何もしない)
fn drop<T>(_x: T) {}

13.2 Sized

sized型:
その型の値のメモリ上でのサイズが常に同じになるような型
→Rustのほとんどの型はsized

unsized型も少数だが存在
→str(&がついていない)や[T](配列スライス,&がついていない)など
→→他にもトレイトオブジェクトの参照先もunsized

unsizedの値を変数に格納したり引数として渡すことはできない
→&strやBox<Write>のようにポインタを介してアクセス
→→unsizedへのポインタは常に2ワード長のファットポインタになる
→→→2ワード目の長さやvtableへのポインタで型に欠けている情報を補う

全てのsizedな型はstd::marker::Sizedトレイトを実装
→メソッドも関連型もない
→適用できる全ての型に対して自動的にこのトレイトを実装
→独自に実装は不可能
→型の制約にのみ使用可能

Sizedのようなトレイトはマーカートレイト(marker trait)と呼ばれる
→なんらかの性質を持っていることをマークするために用いる

<T>をSizedに制約したくない
→<T: ?Sized>を書いて明示的にする
→→Sizedでなくても良いという意味
→→?SizedをSizedかも(questionably sized)ということがある

構造体の最後のfieldはunsizedで良く、そのような構造体はunsizedになる

unsizedな型を直接作ることはできない
→sizedな型の変数で一旦引き受け、それへの参照からunsizedな値への参照を作る
→→この変換は暗黙に行われるのでunsizedな値を期待している関数に変換せずに渡せる

13.3 Clone

std::clone::Cloneトレイトは自身のコピーを作ることができる型のトレイト

trait Clone: Sized {
    fn clone(&self) -> Self;
    fn clone_from(&mut self, source: &Self) {
        *self = source.clone()
    }
}

selfの独立したコピーを作りそれを返す

クローンを作るとそれが保有しているもの全てもコピーすることになる
→時間とメモリの両方で高価である可能性がある
→→参照カウントポインタは例外でカウントをインクリメントして新しいポインタを返す

clone_fromメソッドはselfを書き換えてsourceのcopyにする
→例えばs=t.clone()よりs.clone_from(t)の方がヒープの操作がない分高速

独自型に対して全てのfieldおよび要素をcloneするだけで良くデフォのclone_fromで良い
→#[derive(Clone)]属性で自動的に実装

標準ライブラリに定義されている型
→ほとんどがCloneを実装
→→意味のないもの・失敗する可能性のあるものは非実装
→→→try_cloneメソッドはstd::io::Result<T>を返す

13.4 Copy

Copy型:
std::marker::Copyマーカトレイトを実装している型
→浅いバイト単位でのコピーだけでコピーが可能な型のみ実装可能

trait Copy: Clone {}

Dropトレイトを実装している型はCopyにすることができない

#[derive(Copy)]で自動的に実装することが可能

型をCopyにするかはよく考えた方が良い
→詳しくは4.3で説明した通り

13.5 DerefとDerefMut





















































































